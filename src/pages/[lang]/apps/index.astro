---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import SEO from '../../../components/SEO.astro';
import { generateBreadcrumbSchema } from '../../../utils/schema';
import { LANGUAGES, getUITranslations, defaultLanguage, type LanguageCode } from '../../../utils/i18n';

export const prerender = true;

export async function getStaticPaths() {
  const langs = Object.keys(LANGUAGES).filter(lang => lang !== defaultLanguage);
  return langs.map(lang => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;
const currentLang = (lang || defaultLanguage) as LanguageCode;
const t = getUITranslations(currentLang);

const localizedHref = (path: string) => {
  if (currentLang === defaultLanguage) return path;
  const cleanPath = path === '/' ? '' : path;
  return `/${currentLang}${cleanPath}`;
};

const [apps, serviceInfoEntries] = await Promise.all([
  getCollection('apps').catch(() => []),
  getCollection('service-info'),
]);

const serviceInfo = serviceInfoEntries[0];
const data = serviceInfo?.data || {};
const baseUrl = data.siteUrl || Astro.url.origin;

const breadcrumbs = [
  { name: t.nav.home || 'Home', url: localizedHref('/') },
  { name: t.nav.apps || 'IPTV Apps', url: localizedHref('/apps') },
];

const breadcrumbSchema = generateBreadcrumbSchema(
  breadcrumbs.map(b => ({ ...b, url: `${baseUrl}${b.url}` }))
);

const sortedApps = apps.sort((a: any, b: any) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return (a.data.order || 0) - (b.data.order || 0);
});
---

<BaseLayout currentLang={currentLang}>
  <SEO
    slot="head"
    title={`${t.apps?.title || 'Best IPTV Apps'} - ${data.brandName}`}
    description={t.apps?.metaDesc?.replace('{brand}', data.brandName) || `Discover the best IPTV apps compatible with ${data.brandName}.`}
    canonicalURL={`${baseUrl}/${currentLang}/apps`}
    schema={[breadcrumbSchema]}
    pageType="guide"
    breadcrumbs={breadcrumbs}
    languages={Object.fromEntries(
      Object.keys(LANGUAGES)
        .filter(l => l !== currentLang)
        .map(l => [l, l === defaultLanguage ? `${baseUrl}/apps` : `${baseUrl}/${l}/apps`])
    )}
  />

  <div class="max-w-6xl mx-auto px-4 py-12">
    <nav class="mb-8">
      <ol class="flex items-center gap-2 text-sm text-muted-foreground">
        {breadcrumbs.map((crumb, i) => (
          <>
            {i > 0 && <span>/</span>}
            <li>
              {i < breadcrumbs.length - 1 ? (
                <a href={crumb.url} class="hover:text-primary transition-colors">{crumb.name}</a>
              ) : (
                <span class="text-foreground font-medium">{crumb.name}</span>
              )}
            </li>
          </>
        ))}
      </ol>
    </nav>

    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold mb-4">{t.apps?.title || 'Best IPTV Apps'}</h1>
      <p class="text-xl text-muted-foreground max-w-2xl mx-auto">
        {t.apps?.subtitle?.replace('{brand}', data.brandName) || `These are the best IPTV player apps that work perfectly with ${data.brandName}.`}
      </p>
    </header>

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      {sortedApps.map((app: any) => (
        <a
          href={localizedHref(`/apps/${app.id}`)}
          class="group block p-6 rounded-lg border border-border hover:border-primary transition-all hover:shadow-lg relative"
        >
          {app.data.featured && (
            <span class="absolute -top-3 right-4 px-3 py-1 bg-primary text-primary-foreground text-xs font-semibold rounded-full">
              {t.common?.recommended || 'Recommended'}
            </span>
          )}
          <h2 class="text-xl font-semibold mb-2 group-hover:text-primary transition-colors">
            {app.data.name}
          </h2>
          <p class="text-muted-foreground text-sm mb-4 line-clamp-2">
            {app.data.description}
          </p>
          <div class="flex flex-wrap gap-2">
            {app.data.platforms?.slice(0, 3).map((platform: string) => (
              <span class="px-2 py-1 text-xs bg-muted rounded-md">{platform}</span>
            ))}
          </div>
        </a>
      ))}
    </div>
  </div>
</BaseLayout>
