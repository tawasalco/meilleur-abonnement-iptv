---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import FlashSaleBanner from '../../components/FlashSaleBanner';
import HeroSection from '../../components/HeroSection.astro';
import TrustBadges from '../../components/TrustBadges';
import FeatureGrid from '../../components/FeatureGrid';
import FilmsSeriesSection from '../../components/FilmsSeriesSection';
import SportsSection from '../../components/SportsSection';
import PerformanceSection from '../../components/PerformanceSection';
import GuaranteeSection from '../../components/GuaranteeSection';
import HowToPurchaseSection from '../../components/HowToPurchaseSection';
import CompatibleDevicesSection from '../../components/CompatibleDevicesSection';
import PricingSection from '../../components/PricingSection';
import FreeTrialCTA from '../../components/FreeTrialCTA';
import TestimonialSection from '../../components/TestimonialSection';
import FAQSection from '../../components/FAQSection';
import CTASection from '../../components/CTASection';
import StickyContactButton from '../../components/StickyContactButton';
import MobileBottomCTA from '../../components/MobileBottomCTA';
import SEOContentSection from '../../components/SEOContentSection';
import { LANGUAGES, getUITranslations, defaultLanguage, type LanguageCode } from '../../utils/i18n';
import {
  generateOrganizationSchema,
  generateProductSchema,
  generateWebSiteSchema,
  generateBreadcrumbSchema,
  generateFAQSchema,
  generateReviewSchema,
} from '../../utils/schema';

export const prerender = true;

export async function getStaticPaths() {
  const langs = Object.keys(LANGUAGES).filter(lang => lang !== defaultLanguage);
  return langs.map(lang => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;
const currentLang = (lang || defaultLanguage) as LanguageCode;
const t = getUITranslations(currentLang);

const [serviceInfoEntries, siteConfigEntries, pricingPlans, faqItems, testimonials] = await Promise.all([
  getCollection('service-info'),
  getCollection('site-config').catch(() => []),
  getCollection('pricing'),
  getCollection('faq'),
  getCollection('testimonials').catch(() => []),
]);

const serviceInfo = serviceInfoEntries[0];
const data = serviceInfo?.data || {};
const siteConfig = siteConfigEntries[0]?.data || {};

const guaranteeDays = siteConfig.guaranteeDays || 30;
const channelCount = data.channelCount || 28000;
const vodCount = data.vodCount || 90000;
const countryCount = siteConfig.countryCount || 100;

const baseUrl = data.siteUrl || Astro.url.origin;

const contactInfo = data.contactInfo || {};
const whatsappNumber = contactInfo.whatsappNumber;
const telegramUsername = contactInfo.telegramUsername;

const organizationSchema = generateOrganizationSchema({
  name: data.brandName,
  url: baseUrl,
  logo: `${baseUrl}/favicon.svg`,
  description: data.description,
  email: data.supportEmail,
  phone: data.supportPhone,
  socialProfiles: Object.values(data.socialLinks || {}).filter(Boolean) as string[],
});

const productSchema = generateProductSchema({
  name: `${data.brandName} IPTV Subscription`,
  description: data.description,
  brand: data.brandName,
  offers: pricingPlans.map(plan => ({
    priceCurrency: plan.data.currency,
    price: plan.data.price,
    name: plan.data.name,
    url: `${baseUrl}/pricing`,
  })),
  aggregateRating: {
    ratingValue: 4.9,
    reviewCount: testimonials.length > 0 ? testimonials.length * 127 : 25567,
  },
});

const websiteSchema = generateWebSiteSchema(
  data.brandName,
  baseUrl,
  data.description
);

const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Home', url: baseUrl },
]);

const sortedPricing = [...pricingPlans].sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const sortedFaq = [...faqItems].sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

const faqSchema = sortedFaq.length > 0 
  ? generateFAQSchema(sortedFaq.map(f => ({
      question: f.data.question,
      answer: f.body || f.data.answer || '',
    })))
  : null;

const reviewSchema = testimonials.length > 0
  ? generateReviewSchema(
      testimonials.map(t => ({
        author: t.data.author || t.data.name || 'Customer',
        reviewBody: t.body || t.data.content || '',
        ratingValue: t.data.rating || 5,
        datePublished: t.data.date ? new Date(t.data.date) : undefined,
      })),
      { name: `${data.brandName} IPTV Service` }
    )
  : null;

const schemas = [
  organizationSchema, 
  productSchema, 
  websiteSchema, 
  breadcrumbSchema,
  faqSchema,
  reviewSchema,
].filter(Boolean);
---

<BaseLayout currentLang={currentLang}>
  <SEO
    slot="head"
    title={`${data.brandName} - ${t.seo?.homeTitle || 'Premium IPTV Service'} | ${channelCount.toLocaleString()}+ ${t.seo?.channelsKeyword || 'Channels'}`}
    description={t.seo?.homeDesc?.replace('{channels}', channelCount.toLocaleString()).replace('{vod}', vodCount.toLocaleString()).replace('{days}', String(guaranteeDays)) || data.description || `Experience premium IPTV with ${channelCount.toLocaleString()}+ live channels.`}
    canonicalURL={`${baseUrl}/${currentLang}/`}
    ogImage={`${baseUrl}/og-image.jpg`}
    schema={schemas}
    pageType="home"
    languages={Object.fromEntries(
      Object.keys(LANGUAGES)
        .filter(lang => lang !== currentLang)
        .map(lang => [lang, lang === defaultLanguage ? baseUrl : `${baseUrl}/${lang}/`])
    )}
  />

  <FlashSaleBanner
    client:load
    title={t.flashSale.title}
    offerText={t.flashSale.subtitle}
    ctaText={t.flashSale.claimNow}
    ctaLink="#pricing"
    primaryColor={data.primaryColor}
  />

  <HeroSection
    title={data.brandName}
    subtitle={data.tagline || `Access ${channelCount.toLocaleString()}+ live TV channels and ${vodCount.toLocaleString()}+ movies and series. Premium HD & 4K streaming with 99.9% uptime guarantee.`}
    channelCount={channelCount}
    vodCount={vodCount}
    primaryColor={data.primaryColor}
    showFreeTrial={true}
    whatsappNumber={whatsappNumber}
    trialHours={24}
    trialPrice={siteConfig.trialPrice || 1.99}
    currentLang={currentLang}
  />

  <TrustBadges 
    client:visible 
    primaryColor={data.primaryColor} 
    variant="horizontal"
    guaranteeDays={guaranteeDays}
    translations={{
      moneyBack: t.trustBadges?.moneyBack,
      moneyBackDesc: t.trustBadges?.moneyBackDesc,
      securePayments: t.trustBadges?.securePayments,
      securePaymentsDesc: t.trustBadges?.securePaymentsDesc,
      support247: t.trustBadges?.support247,
      supportDesc: t.trustBadges?.supportDesc,
      instantActivation: t.trustBadges?.instantActivation,
      activationDesc: t.trustBadges?.activationDesc,
    }}
  />

  {data.features && data.features.length > 0 && (
    <FeatureGrid 
      client:visible 
      features={data.features} 
      primaryColor={data.primaryColor}
      translations={{ title: t.features.title, subtitle: t.features.subtitle }}
    />
  )}

  <FilmsSeriesSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor}
    translations={{ title: t.movies.title, subtitle: t.movies.subtitle }}
  />

  <SportsSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor}
    translations={{ title: t.sports.title, subtitle: t.sports.subtitle }}
  />

  <PerformanceSection
    client:visible
    brandName={data.brandName}
    primaryColor={data.primaryColor}
    uptimePercent={99.9}
    channelCount={channelCount}
    countryCount={countryCount}
    translations={{
      title: t.performance?.title,
      subtitle: t.performance?.subtitle?.replace('{brand}', data.brandName || 'IPTV'),
      noBuffering: t.performance?.noBuffering,
      noBufferingDesc: t.performance?.noBufferingDesc?.replace('{brand}', data.brandName || 'IPTV'),
      serverInfra: t.performance?.serverInfra,
      serverInfraDesc: t.performance?.serverInfraDesc,
      antiFreeze: t.performance?.antiFreeze,
      antiFreezeDesc: t.performance?.antiFreezeDesc,
      recommendedSpeed: t.performance?.recommendedSpeed,
      speedRecommendation: t.performance?.speedRecommendation,
      uptime: t.hero?.uptime,
      channels: t.hero?.liveChannels,
      countries: t.performance?.countries,
      support: t.hero?.support,
    }}
  />

  <GuaranteeSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor}
    guaranteeDays={guaranteeDays}
    translations={{
      title: t.guarantee.title.replace('{brand}', data.brandName || 'IPTV'),
      description: t.guarantee.description.replace('{brand}', data.brandName || 'IPTV'),
      point1: t.guarantee.point1,
      point2: t.guarantee.point2,
      point3: t.guarantee.point3.replace('{days}', String(guaranteeDays)),
      point4: t.guarantee.point4,
      ctaButton: t.guarantee.ctaButton,
      dayLabel: t.guarantee.dayLabel,
      badgeText: t.guarantee.badgeText,
    }}
  />

  <HowToPurchaseSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor}
    translations={{
      title: t.howToPurchase?.title,
      subtitle: t.howToPurchase?.subtitle,
      step1Title: t.howToPurchase?.step1Title,
      step1Desc: t.howToPurchase?.step1Desc,
      step2Title: t.howToPurchase?.step2Title,
      step2Desc: t.howToPurchase?.step2Desc,
      step3Title: t.howToPurchase?.step3Title,
      step3Desc: t.howToPurchase?.step3Desc,
    }}
  />

  <CompatibleDevicesSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor}
    translations={{ title: t.devices.title, subtitle: t.devices.subtitle }}
  />

  <div id="pricing">
    {sortedPricing.length > 0 && (
      <PricingSection
        client:visible
        plans={sortedPricing.map(p => ({ ...p.data, slug: p.id }))}
        primaryColor={data.primaryColor}
        paymentSettings={data.paymentSettings}
        brandName={data.brandName}
        translations={{
          secureCheckout: t.pricing?.secureCheckout,
          reviews: t.pricing?.reviews,
          flashSaleTitle: t.pricing?.flashSaleTitle,
          priceReturns: t.pricing?.priceReturns,
          buyNow: t.pricing?.buyNow,
          popular: t.pricing?.popular,
          bestValue: t.pricing?.bestValue,
          selectDevices: t.pricing?.selectDevices,
          device: t.pricing?.device,
          devices: t.pricing?.devices,
          headerTitle: t.pricing?.headerTitle,
          headerSubtitle: t.pricing?.headerSubtitle,
          starterPackage: t.pricing?.starterPackage,
          standardPackage: t.pricing?.standardPackage,
          premiumPackage: t.pricing?.premiumPackage,
          noBindingContract: t.pricing?.noBindingContract,
          threeMonths: t.pricing?.threeMonths,
          sixMonths: t.pricing?.sixMonths,
          twelveMonths: t.pricing?.twelveMonths,
          bonusMonths: t.pricing?.bonusMonths,
          globalChannels: t.pricing?.globalChannels,
          moviesSeriesCount: t.pricing?.moviesSeriesCount,
          timeShift: t.pricing?.timeShift,
          qualityAll: t.pricing?.qualityAll,
          antiFreeze: t.pricing?.antiFreeze,
          dailyUpdates: t.pricing?.dailyUpdates,
          moneyBackGuarantee: t.pricing?.moneyBackGuarantee,
        }}
      />
    )}
  </div>

  <FreeTrialCTA
    client:visible
    brandName={data.brandName}
    channelCount={channelCount}
    trialHours={24}
    primaryColor={data.primaryColor}
    whatsappNumber={whatsappNumber}
    translations={{
      badge: t.trial.badge,
      title: t.trial.title.replace('{brand}', data.brandName || 'IPTV'),
      subtitle: t.trial.subtitle,
      feature1: `${channelCount.toLocaleString()}+ ${t.hero.liveChannels}`,
      feature2: t.hero.hdQuality,
      feature3: t.trial.fullAccess,
      feature4: t.hero.noCardRequired,
      ctaButton: t.trial.ctaButton,
      hoursFree: t.trial.hoursFree,
      fullAccess: t.trial.fullAccess,
      instantAccess: t.trial.instantAccess,
      noCommitment: t.trial.noCommitment,
    }}
  />

  {testimonials.length > 0 && (
    <TestimonialSection
      client:visible
      testimonials={testimonials.map(testim => ({ 
        ...testim.data, 
        content: testim.body || testim.data.content || '',
        verified: true,
      }))}
      primaryColor={data.primaryColor}
      showCTA={true}
      ctaLink="#pricing"
      translations={{
        title: t.testimonials.title,
        subtitle: t.testimonials.subtitle,
        reviews: t.testimonials.reviews,
        verifiedPurchase: t.testimonials.verifiedPurchase,
        ctaButton: t.testimonials.ctaButton,
      }}
    />
  )}

  {sortedFaq.length > 0 && (
    <FAQSection 
      client:visible 
      items={sortedFaq.map(f => ({ question: f.data.question, answer: f.body || '' }))} 
      translations={{ title: t.faq.title, subtitle: t.faq.subtitle }}
    />
  )}

  <SEOContentSection
    client:visible
    brandName={data.brandName || 'IPTV Service'}
    channelCount={channelCount}
    countryCount={countryCount}
    vodCount={vodCount}
    primaryColor={data.primaryColor}
    translations={{
      whyChoose: (t.seoContent?.whyChoose || 'Why Choose {brand}?').replace('{brand}', data.brandName || 'IPTV Service'),
      subtitle: (t.seoContent?.subtitle || 'The most trusted IPTV service provider with {channels}+ live channels, {vod}+ movies & series, and customers in {countries}+ countries.').replace('{channels}', channelCount.toLocaleString()).replace('{vod}', vodCount.toLocaleString()).replace('{countries}', String(countryCount)),
      premiumStreaming: t.seoContent?.premiumStreaming || 'Premium IPTV Streaming',
      premiumStreamingDesc: (t.seoContent?.premiumStreamingDesc || '{brand} delivers crystal-clear HD and 4K streaming to your favorite devices.').replace('{brand}', data.brandName || 'IPTV Service'),
      worldwideCoverage: t.seoContent?.worldwideCoverage || 'Worldwide Coverage',
      worldwideCoverageDesc: (t.seoContent?.worldwideCoverageDesc || 'Access channels from over {countries}+ countries.').replace('{countries}', String(countryCount)),
      noBuffering: t.seoContent?.noBuffering || 'No Buffering Technology',
      noBufferingDesc: t.seoContent?.noBufferingDesc || 'Our global server network ensures the fastest streaming speeds with minimal latency.',
      securePrivate: t.seoContent?.securePrivate || 'Secure & Private',
      securePrivateDesc: t.seoContent?.securePrivateDesc || 'Your privacy matters. We use industry-standard encryption to protect your connection.',
      instantActivation: t.seoContent?.instantActivation || 'Instant Activation',
      instantActivationDesc: t.seoContent?.instantActivationDesc || 'Get started in minutes, not days. After purchase, your credentials are delivered instantly.',
      support247: t.seoContent?.support247 || '24/7 Customer Support',
      support247Desc: t.seoContent?.support247Desc || 'Our dedicated support team is available around the clock via WhatsApp, Telegram, and email.',
      whatIsIPTV: (t.seoContent?.whatIsIPTV || 'What is IPTV and How Does {brand} Work?').replace('{brand}', data.brandName || 'IPTV Service'),
      whatIsIPTVDesc: (t.seoContent?.whatIsIPTVDesc || 'IPTV delivers television content over the internet. {brand} provides access to {channels}+ live TV channels.').replace('{brand}', data.brandName || 'IPTV Service').replace('{channels}', channelCount.toLocaleString()),
      keyBenefits: (t.seoContent?.keyBenefits || 'Key Benefits of {brand}:').replace('{brand}', data.brandName || 'IPTV Service'),
      costEffective: t.seoContent?.costEffective || 'Cost-Effective: Save up to 85% compared to traditional cable or satellite TV subscriptions',
      multiDevice: t.seoContent?.multiDevice || 'Multi-Device Support: Watch on Smart TVs, Android boxes, Firestick, iOS, Android phones, tablets, and more',
      hdQuality: t.seoContent?.hdQuality || 'HD & 4K Quality: Enjoy crystal-clear picture quality on all supported channels',
      epgGuide: t.seoContent?.epgGuide || 'EPG (Electronic Program Guide): Never miss your favorite shows with our comprehensive TV guide',
      multiLanguage: t.seoContent?.multiLanguage || 'Multi-Language Support: Content available in multiple languages',
      dvrCatchUp: t.seoContent?.dvrCatchUp || 'DVR & Catch-Up: Record live TV and watch programs you missed for up to 7 days',
      compatibleDevices: t.seoContent?.compatibleDevices || 'Compatible Devices and Apps',
      compatibleDevicesDesc: (t.seoContent?.compatibleDevicesDesc || '{brand} works seamlessly with all popular IPTV apps.').replace('{brand}', data.brandName || 'IPTV Service'),
      sportsCoverage: t.seoContent?.sportsCoverage || 'Sports Coverage',
      sportsCoverageDesc: t.seoContent?.sportsCoverageDesc || 'Never miss a game with our comprehensive sports coverage.',
      entertainment: t.seoContent?.entertainment || 'Entertainment & Movies',
      entertainmentDesc: (t.seoContent?.entertainmentDesc || 'With {vod}+ movies and TV series on demand.').replace('{vod}', vodCount.toLocaleString()),
      showLess: t.seoContent?.showLess || 'Show Less',
      learnMore: (t.seoContent?.learnMore || 'Learn More About {brand}').replace('{brand}', data.brandName || 'IPTV Service'),
    }}
  />

  <CTASection
    client:visible
    title={t.cta.readyToStream || 'Ready to Start Streaming?'}
    subtitle={t.cta.joinThousands?.replace('{channels}', channelCount.toLocaleString()) || `Join thousands of satisfied customers and experience premium entertainment with ${channelCount.toLocaleString()}+ channels`}
    buttonText={t.hero.getStarted}
    buttonLink="#pricing"
    primaryColor={data.primaryColor}
  />

  <StickyContactButton
    client:load
    whatsappNumber={whatsappNumber}
    telegramUsername={telegramUsername}
    brandName={data.brandName}
    primaryColor={data.primaryColor}
  />

  <MobileBottomCTA
    client:load
    pricingLink="#pricing"
    trialLink={whatsappNumber ? `https://wa.me/${whatsappNumber}` : '/free-trial'}
    primaryColor={data.primaryColor}
    showTrial={true}
  />
</BaseLayout>
