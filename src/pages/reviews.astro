---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import SEO from '../components/SEO.astro';
import { Star, CheckCircle, MapPin, Quote } from 'lucide-react';
import {
  generateBreadcrumbSchema,
  generateReviewSchema,
} from '../utils/schema';

const [serviceInfoEntries, testimonials] = await Promise.all([
  getCollection('service-info'),
  getCollection('testimonials').catch(() => []),
]);

const serviceInfo = serviceInfoEntries[0];
const data = serviceInfo?.data || {};
const baseUrl = data.siteUrl || Astro.url.origin;

const sortedTestimonials = [...testimonials].sort((a, b) => 
  (b.data.rating || 5) - (a.data.rating || 5)
);

const totalReviews = sortedTestimonials.length || 50;
const avgRating = sortedTestimonials.length > 0
  ? (sortedTestimonials.reduce((sum, t) => sum + (t.data.rating || 5), 0) / sortedTestimonials.length).toFixed(1)
  : '4.9';

const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Home', url: baseUrl },
  { name: 'Reviews', url: `${baseUrl}/reviews` },
]);

const reviewSchema = sortedTestimonials.length > 0
  ? generateReviewSchema(
      sortedTestimonials.map(t => ({
        author: t.data.name || 'Customer',
        reviewBody: t.body || '',
        ratingValue: t.data.rating || 5,
      })),
      { name: `${data.brandName} IPTV Service` }
    )
  : null;

const aggregateRatingSchema = {
  "@context": "https://schema.org",
  "@type": "AggregateRating",
  "itemReviewed": {
    "@type": "Product",
    "name": `${data.brandName} IPTV Service`,
    "brand": data.brandName,
  },
  "ratingValue": avgRating,
  "bestRating": "5",
  "worstRating": "1",
  "ratingCount": totalReviews * 100,
  "reviewCount": totalReviews,
};

const schemas = [breadcrumbSchema, reviewSchema, aggregateRatingSchema].filter(Boolean);

const ITEMS_PER_PAGE = 12;
---

<BaseLayout>
  <SEO
    slot="head"
    title={`Customer Reviews | ${data.brandName} - ${avgRating}/5 Stars from ${totalReviews}+ Reviews`}
    description={`Read verified customer reviews of ${data.brandName} IPTV service. ${avgRating}/5 star rating from ${totalReviews}+ satisfied customers. Real testimonials about streaming quality, support, and value.`}
    canonicalURL={`${baseUrl}/reviews`}
    schema={schemas}
    pageType="reviews"
  />

  <main class="min-h-screen bg-background">
    <section class="py-16 lg:py-24">
      <div class="container mx-auto px-4">
        <div class="text-center max-w-3xl mx-auto mb-12">
          <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-500/10 text-green-600 mb-6">
            <CheckCircle className="w-4 h-4" />
            <span class="text-sm font-medium">Verified Customer Reviews</span>
          </div>
          
          <h1 class="text-4xl md:text-5xl font-bold mb-6">
            What Our Customers Say About{' '}
            <span style={`color: ${data.primaryColor}`}>{data.brandName}</span>
          </h1>

          <div class="flex items-center justify-center gap-4 mb-6">
            <div class="flex items-center gap-1">
              {[...Array(5)].map((_, i) => (
                <Star 
                  className={`w-6 h-6 ${i < Math.floor(parseFloat(avgRating)) ? 'fill-yellow-400 text-yellow-400' : 'text-muted-foreground'}`}
                />
              ))}
            </div>
            <span class="text-2xl font-bold">{avgRating}/5</span>
            <span class="text-muted-foreground">({(totalReviews * 100).toLocaleString()}+ reviews)</span>
          </div>

          <p class="text-lg text-muted-foreground">
            Join thousands of satisfied customers enjoying premium IPTV entertainment
          </p>
        </div>

        <div id="reviews-container" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {sortedTestimonials.slice(0, ITEMS_PER_PAGE).map((testimonial, index) => (
            <article 
              class="review-card bg-card border border-border rounded-xl p-6 hover:shadow-lg transition-shadow"
              data-index={index}
            >
              <div class="flex items-start gap-4 mb-4">
                <div 
                  class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0"
                  style={`background-color: ${data.primaryColor}`}
                >
                  {(testimonial.data.name || 'C').charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <h3 class="font-semibold text-foreground">{testimonial.data.name}</h3>
                    <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-green-500/10 text-green-600">
                      <CheckCircle className="w-3 h-3" />
                      Verified
                    </span>
                  </div>
                  {testimonial.data.location && (
                    <div class="flex items-center gap-1 text-sm text-muted-foreground mt-0.5">
                      <MapPin className="w-3 h-3" />
                      <span>{testimonial.data.location}</span>
                    </div>
                  )}
                </div>
              </div>

              <div class="flex items-center gap-1 mb-3">
                {[...Array(5)].map((_, i) => (
                  <Star 
                    className={`w-4 h-4 ${i < (testimonial.data.rating || 5) ? 'fill-yellow-400 text-yellow-400' : 'text-muted-foreground'}`}
                  />
                ))}
              </div>

              <blockquote class="relative">
                <Quote className="absolute -top-1 -left-1 w-6 h-6 text-muted-foreground/20" />
                <p class="text-muted-foreground pl-5 line-clamp-4">
                  {testimonial.body || 'Great service! Highly recommended.'}
                </p>
              </blockquote>
            </article>
          ))}
        </div>

        {sortedTestimonials.length > ITEMS_PER_PAGE && (
          <div class="text-center mt-10">
            <button
              id="load-more-btn"
              class="inline-flex items-center gap-2 px-8 py-3 rounded-lg font-semibold text-white transition-opacity hover:opacity-90"
              style={`background-color: ${data.primaryColor}`}
              data-page="1"
              data-total={sortedTestimonials.length}
            >
              Load More Reviews
            </button>
          </div>
        )}

        <div class="mt-16 text-center">
          <div class="inline-block bg-card border border-border rounded-xl p-8 max-w-xl">
            <h2 class="text-2xl font-bold mb-4">Ready to Join Our Happy Customers?</h2>
            <p class="text-muted-foreground mb-6">
              Experience premium IPTV entertainment with 24/7 support and a money-back guarantee.
            </p>
            <a
              href="/pricing"
              class="inline-flex items-center gap-2 px-8 py-3 rounded-lg font-semibold text-white transition-opacity hover:opacity-90"
              style={`background-color: ${data.primaryColor}`}
            >
              View Our Plans
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>

<script define:vars={{ testimonials: sortedTestimonials.map(t => ({ ...t.data, body: t.body })), ITEMS_PER_PAGE, primaryColor: data.primaryColor }}>
  document.addEventListener('DOMContentLoaded', () => {
    const loadMoreBtn = document.getElementById('load-more-btn');
    const container = document.getElementById('reviews-container');
    
    if (!loadMoreBtn || !container) return;
    
    let currentPage = 1;
    
    loadMoreBtn.addEventListener('click', () => {
      currentPage++;
      const start = currentPage * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const newItems = testimonials.slice(start, end);
      
      newItems.forEach((t, i) => {
        const article = document.createElement('article');
        article.className = 'review-card bg-card border border-border rounded-xl p-6 hover:shadow-lg transition-shadow animate-fade-in';
        article.innerHTML = `
          <div class="flex items-start gap-4 mb-4">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0" style="background-color: ${primaryColor}">
              ${(t.name || 'C').charAt(0).toUpperCase()}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <h3 class="font-semibold text-foreground">${t.name || 'Customer'}</h3>
                <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-green-500/10 text-green-600">
                  Verified
                </span>
              </div>
              ${t.location ? `<div class="flex items-center gap-1 text-sm text-muted-foreground mt-0.5"><span>${t.location}</span></div>` : ''}
            </div>
          </div>
          <div class="flex items-center gap-1 mb-3">
            ${[...Array(5)].map((_, i) => `<svg class="w-4 h-4 ${i < (t.rating || 5) ? 'fill-yellow-400 text-yellow-400' : 'text-muted-foreground'}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`).join('')}
          </div>
          <blockquote class="relative">
            <p class="text-muted-foreground pl-5 line-clamp-4">${t.body || 'Great service! Highly recommended.'}</p>
          </blockquote>
        `;
        container.appendChild(article);
      });
      
      if (end >= testimonials.length) {
        loadMoreBtn.style.display = 'none';
      }
    });
  });
</script>
